#!yab

doc RdefApply 
doc adds icon, application signature and version info attributes from an rdef file.
doc
doc Copyright Â© 2015 Jim Saxton, Fat Elk Software

if (peek("argument") >= 2) then
	filename$=peek$("argument")
	Outfilename$=peek$("argument")
	make$=peek$("argument")
	make=0
	if (make$="M") make=1
	readicon()
	readappsig()
	readversion()
else
	print"RdefApply" 
 	print "Adds icon, application signature and version info attributes from an rdef file.
 	"
	print "usage:"
	print "RdefApply <RdefFilename> <OutputFilename> <M>"
	print "if M is used, OutoutFilename is created if it does not exist
or the creation date is set if it does exist."
endif	

sub readicon()
	if (not open(1,filename$)) print "Could not open file'"+filename$+"' for reading":exit
	open #2,filename$+".hvicon","wb" 
	convert=false
	while(not eof(1)) 
		line input #1 a$
		if (a$="resource vector_icon {") convert=true: line input #1 a$ 
		if (a$="};") convert=false
		if convert then
			a$=clean$(a$)
			l=len(a$)
			x=1
			do 
				poke #2,dec(mid$(a$,x,2))
				x=x+2
			if (x>=l) break 
			loop 
	 	end if
	 wend
	close #1
	close #2
	if (make=1) system("touch "+Outfilename$)
	if (system("addattr -f "+filename$+".hvicon -t icon BEOS:ICON "+Outfilename$))then 
		print "
usage:"
		print "RdefApply <RdefFilename> <OutputFilename> <M>"
		print "if M is used, OutoutFilename is created if it does not exist
or the creation date is set if it does exist."
	 	system("rm "+filename$+".hvicon")
	 	exit
	endif 
	system("rm "+filename$+".hvicon") 
end sub

sub clean$(string$)
	pos=instr(string$,"$")
	mid$(string$,pos)=" "
	pos=instr(string$,chr$(34))
	mid$(string$,pos)=" "
	pos=instr(string$,chr$(34))
	mid$(string$,pos)=" "
	string$=trim$(string$)
	return string$
end sub

sub readappsig()

end sub

sub readversion()

end sub
